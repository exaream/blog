<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MySQL EXPLAIN"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="MySQL EXPLAIN"><meta property="og:description" content="MySQL EXPLAIN"><meta property="og:type" content="article"><meta property="og:url" content="https://exaream.dev/mysql/explain/"><meta property="article:section" content="mysql"><meta property="article:published_time" content="2020-01-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-01T00:00:00+00:00"><title>MySQL EXPLAIN | Tech</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.41cfbac41cf36bc51c4b896ea95767163d1a67286b1954fc062d3e1ceb332bec.css integrity="sha256-Qc+6xBzza8UcS4luqVdnFj0aZyhrGVT8Bi0+HOszK+w=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.b32f69d186c4afe03da31191c75f29cd7018b40be309069e382f0e027e32d86d.js integrity="sha256-sy9p0YbEr+A9oxGRx18pzXAYtAvjCQaeOC8OAn4y2G0=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W638642WNE"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W638642WNE",{anonymize_ip:!1})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-W638642WNE"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W638642WNE")</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Tech</span></a></h2><h3 id=menu>Menu
<a class=anchor href=#menu>#</a></h3><ul><li><strong><a href=https://exaream.dev/git/>Git</a></strong><ul><li><a href=https://exaream.dev/git/basic/>Git Basic</a></li><li><a href=https://exaream.dev/git/tool/>Git Tool</a></li></ul></li><li><strong><a href=https://exaream.dev/container/>Container</a></strong><ul><li><a href=https://exaream.dev/container/docker/>Docker</a></li><li><a href=https://exaream.dev/container/docker-compose/>Docker Compose</a></li><li><a href=https://exaream.dev/container/docker-swarm/>Docker Swarm</a></li></ul></li><li><strong><a href=https://exaream.dev/mysql/>MySQL</a></strong><ul><li><a href=https://exaream.dev/mysql/basic/>MySQL Basic</a></li><li><a href=https://exaream.dev/mysql/explain/>MySQL EXPLAIN</a></li></ul></li><li><strong><a href=https://exaream.dev/mysql/>PostgreSQL</a></strong><ul><li><a href=https://exaream.dev/postgresql/basic/>PostgreSQL Basic</a></li></ul></li><li><strong><a href=https://exaream.dev/go/>Go</a></strong><ul><li><a href=https://exaream.dev/go/check-list/>Go Check List</a></li><li><a href=https://exaream.dev/go/test/>Go Test</a></li><li><a href=https://exaream.dev/go/testscript/>Go TestScript</a></li><li><a href=https://exaream.dev/go/link/>Go Link</a></li></ul></li><li><strong><a href=https://exaream.dev/linux/>Linux</a></strong><ul><li><a href=https://exaream.dev/linux/command/>Linux Command</a></li><li><a href=https://exaream.dev/linux/ubuntu/>Ubuntu</a></li></ul></li><li><strong><a href=https://exaream.dev/python/>Python</a></strong><ul><li><a href=https://exaream.dev/python/basic/>Python Basic</a></li><li><a href=https://exaream.dev/python/ocr/>Python OCR</a></li></ul></li><li><strong><a href=https://exaream.dev/php/>PHP</a></strong><ul><li><a href=https://exaream.dev/php/phpunit/>PHPUnit</a></li><li><a href=https://exaream.dev/php/upgrade/>PHP Upgrade</a></li><li><a href=https://exaream.dev/php/phpmetrics/>PhpMetrics</a></li><li><a href=https://exaream.dev/php/command-line/>PHP Command Line</a></li></ul></li><li><strong><a href=https://exaream.dev/javascript/>JavaScript</a></strong><ul><li><a href=https://exaream.dev/javascript/nodejs/>Node.js</a></li></ul></li><li><strong><a href=https://exaream.dev/shellscript/>Shellscript</a></strong><ul><li><a href=https://exaream.dev/shellscript/memo/>Shellscript Memo</a></li></ul></li><li><strong><a href=https://exaream.dev/mac/>Mac</a></strong><ul><li><a href=https://exaream.dev/mac/setting/>Mac Setting</a></li><li><a href=https://exaream.dev/mac/iterm2/>iTerm2</a></li><li><a href=https://exaream.dev/mac/brew/>Homebrew</a></li></ul></li><li><strong><a href=https://exaream.dev/tool/>Tool</a></strong><ul><li><a href=https://exaream.dev/tool/hugo/>Hugo</a></li><li><a href=https://exaream.dev/tool/jenkins/>Jenkins</a></li><li><a href=https://exaream.dev/tool/vscode/>VS Code</a></li><li><a href=https://exaream.dev/tool/excel/>Excel</a></li><li><a href=https://exaream.dev/tool/mailcatcher/>MailCatcher</a></li></ul></li><li><strong><a href=https://exaream.dev/lang/>Language</a></strong><ul><li><a href=https://exaream.dev/lang/english/>English</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>MySQL EXPLAIN</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><h2>Tags</h2><ul class=tags><li><a href=/tags/mysql>MySQL</a><li><a href=/tags/sql>SQL</a><li><a href=/tags/explain>EXPLAIN</a></ul><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#前提>前提</a></li><li><a href=#sqlチューニングの手順>SQLチューニングの手順</a></li><li><a href=#スロークエリーログ>スロークエリーログ</a><ul><li><a href=#設定の項目>設定の項目</a></li><li><a href=#設定の方法>設定の方法</a></li><li><a href=#設定の確認>設定の確認</a></li></ul></li><li><a href=#集計方法>集計方法</a><ul><li><a href=#集計の種類>集計の種類</a></li><li><a href=#mysqldumpslow-コマンドの使用方法><code>mysqldumpslow</code> コマンドの使用方法</a></li><li><a href=#mysqldumpslow-コマンドのオプション><code>mysqldumpslow</code> コマンドのオプション</a></li></ul></li><li><a href=#実行計画>実行計画</a><ul><li><a href=#実行計画とは>実行計画とは</a></li><li><a href=#確認の構文>確認の構文</a></li><li><a href=#確認のステップ>確認のステップ</a></li><li><a href=#項目の説明>項目の説明</a></li></ul></li><li><a href=#クエリの改善策>クエリの改善策</a><ul><li><a href=#レコード数を絞れる条件は早い段階で記述>レコード数を絞れる条件は早い段階で記述</a></li><li><a href=#サブクエリを引数にとる場合in句よりもexistsを使用>サブクエリを引数にとる場合、IN句よりもEXISTSを使用</a></li><li><a href=#中間テーブルを減らす>中間テーブルを減らす</a></li><li><a href=#ソートを回避>ソートを回避</a></li><li><a href=#where句で書ける条件はhaving句には書かない>WHERE句で書ける条件はHAVING句には書かない</a></li><li><a href=#groupby句とorderby句でインデックスを使用する>GROUPBY句とORDERBY句でインデックスを使用する</a></li></ul></li><li><a href=#インデックス>インデックス</a><ul><li><a href=#インデックスの操作>インデックスの操作</a></li><li><a href=#インデックスを追加する際のポイント>インデックスを追加する際のポイント</a></li><li><a href=#カーディナリティとは>カーディナリティとは</a></li><li><a href=#インデックスが適用されないケース>インデックスが適用されないケース</a></li></ul></li><li><a href=#その他>その他</a><ul><li><a href=#index-full-scan-全索引検索とは><code>INDEX FULL SCAN</code> (全索引検索)とは</a></li></ul></li><li><a href=#参照>参照</a></li></ul></nav></aside></header><ol class=breadcrumb><li><a href=https://exaream.dev/>Home</a></li><li><a href=https://exaream.dev/mysql/>MySQL</a></li><li class=active><a href=https://exaream.dev/mysql/explain/>EXPLAIN</a></li></ol><article class=markdown><h1 id=mysql-explain>MySQL EXPLAIN
<a class=anchor href=#mysql-explain>#</a></h1><h2 id=前提>前提
<a class=anchor href=#%e5%89%8d%e6%8f%90>#</a></h2><ul><li>MySQL 5.7（エネルギー開発部で現在メインで使用しているMySQLバージョン）</li><li>Clustrix は挙動が異なる可能性があるため対象外。</li></ul><h2 id=sqlチューニングの手順>SQLチューニングの手順
<a class=anchor href=#sql%e3%83%81%e3%83%a5%e3%83%bc%e3%83%8b%e3%83%b3%e3%82%b0%e3%81%ae%e6%89%8b%e9%a0%86>#</a></h2><ul><li>スロークエリ（重いクエリ）を抽出。<ul><li>スロークエリ・ログに記録。</li><li>スロークエリを集計。</li></ul></li><li>実行計画（MySQLが内部的に立てる実行手順）=「MySQLの意思表示」を確認。<ul><li>EXPLAIN を、<code>SELECT</code>・<code>DELETE</code>・<code>INSERT</code>・<code>REPLACE</code>・<code>UPDATE</code> の先頭につけて実行。（MySQL5.6.3より前は <code>SELECT</code> のみ）</li></ul></li><li>チューニング。<ul><li>SQLの改善。</li><li><code>INDEX</code>（テーブルの索引）の追加。日本語では「インデックスを張（は）る」と言う場合が多い。</li><li>テーブル構成の見直し。</li></ul></li></ul><h2 id=スロークエリーログ>スロークエリーログ
<a class=anchor href=#%e3%82%b9%e3%83%ad%e3%83%bc%e3%82%af%e3%82%a8%e3%83%aa%e3%83%bc%e3%83%ad%e3%82%b0>#</a></h2><h3 id=設定の項目>設定の項目
<a class=anchor href=#%e8%a8%ad%e5%ae%9a%e3%81%ae%e9%a0%85%e7%9b%ae>#</a></h3><table><thead><tr><th>設定項目</th><th>設定内容</th></tr></thead><tbody><tr><td><code>slow_query_log</code></td><td>スロークエリーログを出力する際に必要となる設定。デフォルト値は0。</td></tr><tr><td><code>long_query_time</code></td><td>スロークエリーログを出力するための閾値（しきいち）の設定。0秒~360024365の範囲で指定。小数点以下の値を指定することでμs単位まで指定が可能。0秒を指定することで発行されたSQLを全部保存することも可能。</td></tr><tr><td><code>log_queries_not_using_indexes</code></td><td>インデックスが未使用なクエリに関して記録をする設定。</td></tr><tr><td><code>slow_query_log_file</code></td><td>スロークエリーログが出力される先を指定。</td></tr></tbody></table><h3 id=設定の方法>設定の方法
<a class=anchor href=#%e8%a8%ad%e5%ae%9a%e3%81%ae%e6%96%b9%e6%b3%95>#</a></h3><ul><li>設定値は、1 が ON、0 が OFF。</li><li>最後の <code>slow_query_log_file</code> のsetでエラーが出た場合は，別のディレクトリを指定するか，もしくは指定したファイルを適宜作って書き込み権限を与えること。</li></ul><p><strong>MySQLのコンソールから設定</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysql&gt; SET GLOBAL slow_query_log <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>mysql&gt; SET GLOBAL long_query_time <span style=color:#f92672>=</span> 5;
</span></span><span style=display:flex><span>mysql&gt; SET GLOBAL log_queries_not_using_indexes <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>mysql&gt; SET GLOBAL slow_query_log_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/path/to/mysql/slow_query.log&#39;</span>;
</span></span></code></pre></div><p><strong>my.cnf から設定</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>mysqld<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>slow_query_log<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>long_query_time<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>log_queries_not_using_indexes<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>slow_query_log_file<span style=color:#f92672>=</span>/path/to/mysql/slow_query.log
</span></span></code></pre></div><p><strong>mysqld 再起動 (CentOS7の場合)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart mysqld
</span></span></code></pre></div><h3 id=設定の確認>設定の確認
<a class=anchor href=#%e8%a8%ad%e5%ae%9a%e3%81%ae%e7%a2%ba%e8%aa%8d>#</a></h3><ul><li><code>slow_query_log</code> がOFFになっているとスロークエリの出力されないため要注意。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;slow%&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+---------------------+-------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> Variable_name       <span style=color:#f92672>|</span> Value                         <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+---------------------+-------------------------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> slow_launch_time    <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span>                             <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> slow_query_log      <span style=color:#f92672>|</span> <span style=color:#66d9ef>ON</span>                            <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> slow_query_log_file <span style=color:#f92672>|</span> <span style=color:#f92672>/</span>path<span style=color:#f92672>/</span><span style=color:#66d9ef>to</span><span style=color:#f92672>/</span>mysql<span style=color:#f92672>/</span>slow_query.log <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+---------------------+-------------------------------+</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;long%&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>+-----------------+-----------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> Variable_name   <span style=color:#f92672>|</span> Value     <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+-----------------+------------+</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> long_query_time <span style=color:#f92672>|</span> <span style=color:#ae81ff>10</span>.<span style=color:#ae81ff>000000</span> <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+-----------------+-----------+</span>
</span></span></code></pre></div><h2 id=集計方法>集計方法
<a class=anchor href=#%e9%9b%86%e8%a8%88%e6%96%b9%e6%b3%95>#</a></h2><h3 id=集計の種類>集計の種類
<a class=anchor href=#%e9%9b%86%e8%a8%88%e3%81%ae%e7%a8%ae%e9%a1%9e>#</a></h3><ul><li><code>mysqldumpslow</code> コマンドでソート</li><li>MySQL Tuner 等のツールを使用　https://github.com/major/MySQLTuner-perl</li></ul><h3 id=mysqldumpslow-コマンドの使用方法><code>mysqldumpslow</code> コマンドの使用方法
<a class=anchor href=#mysqldumpslow-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95>#</a></h3><ul><li>発生回数でソート</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysqldumpslow -s c /path/to/mysql/slow_query.log
</span></span></code></pre></div><ul><li>合計処理時間でソート</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mysqldumpslow -s t /path/to/mysql/slow_query.log
</span></span></code></pre></div><h3 id=mysqldumpslow-コマンドのオプション><code>mysqldumpslow</code> コマンドのオプション
<a class=anchor href=#mysqldumpslow-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%81%ae%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3>#</a></h3><ul><li><code>-a</code> 匿名化されたくない場合は，<code>-a</code> オプションを利用することで生のデータを出力</li><li><code>-t</code> 引数に指定した個数分の結果を返却</li><li><code>-s</code> ソート</li></ul><table><thead><tr><th>オプションの引数</th><th>並べ替えができる項目</th></tr></thead><tbody><tr><td><code>t</code></td><td>Time</td></tr><tr><td><code>l</code></td><td>Lock</td></tr><tr><td><code>r</code></td><td>Rows</td></tr><tr><td><code>c</code></td><td>Count</td></tr></tbody></table><h2 id=実行計画>実行計画
<a class=anchor href=#%e5%ae%9f%e8%a1%8c%e8%a8%88%e7%94%bb>#</a></h2><ul><li><a href=http://nippondanji.blogspot.com/2009/03/mysqlexplain.html>http://nippondanji.blogspot.com/2009/03/mysqlexplain.html</a></li></ul><h3 id=実行計画とは>実行計画とは
<a class=anchor href=#%e5%ae%9f%e8%a1%8c%e8%a8%88%e7%94%bb%e3%81%a8%e3%81%af>#</a></h3><ul><li>MySQLが内部的に立てる実行手順 = MySQLの意思表示。</li></ul><h3 id=確認の構文>確認の構文
<a class=anchor href=#%e7%a2%ba%e8%aa%8d%e3%81%ae%e6%a7%8b%e6%96%87>#</a></h3><ul><li><code>EXPLAIN</code> を、<code>SELECT</code>・<code>DELETE</code>・<code>INSERT</code>・<code>REPLACE</code>・<code>UPDATE</code> の先頭につけて実行。</li><li>MySQL5.6.3より前は <code>SELECT</code> のみ使用可能なため、<code>UPDATE</code>・<code>DELETE</code> を <code>SELECT</code> に書き換えて使用。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    id,
</span></span><span style=display:flex><span>    title
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    posts
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    title <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#34;Sample%&#34;</span>;
</span></span></code></pre></div><h3 id=確認のステップ>確認のステップ
<a class=anchor href=#%e7%a2%ba%e8%aa%8d%e3%81%ae%e3%82%b9%e3%83%86%e3%83%83%e3%83%97>#</a></h3><ol><li><code>id</code> <code>select_type</code> <code>table</code> フィールドを見て、どのテーブルがどの順序でアクセスされるのかを知る。<br>これらはクエリの構造を示すフィールドであると言える。<br>サブクエリが含まれている場合には <code>EXPLAIN</code> の表示順とアクセスされる順序が異なる場合があるので気をつける必要がある。</li><li><code>type</code> <code>key</code> <code>ref</code> <code>rows</code> フィールドを見て、各テーブルから行がどのようにフェッチされるのかを知る。<br>どのテーブルへのアクセスが最も重いか（クエリの性能の足を引っ張っているのか）を、これらのフィールドから判断することができる。</li><li><code>Extra</code> フィールドを見て、Optimizer（MySQLの最適化装置）がどのように判断して、各々のテーブルへのアクセスにおいて何を実行しているのかを知る。<br><code>Extra</code> フィールドは Optimizer（MySQLの最適化装置）の挙動を示すものであり、クエリの全体像を把握するのに役立つ。</li></ol><h3 id=項目の説明>項目の説明
<a class=anchor href=#%e9%a0%85%e7%9b%ae%e3%81%ae%e8%aa%ac%e6%98%8e>#</a></h3><p><strong>id</strong></p><ul><li><code>SELECT</code> ごとに振られる <code>ID</code>。</li><li>処理順でない場合があるため要注意。詳細は <code>select_type</code> の補足欄を参照。</li></ul><p><strong>select_type</strong></p><ul><li><code>SELECT</code> の種類。</li><li><code>SIMPLE</code>, <code>SUBQUERY</code>, <code>UNION</code> 等。</li></ul><p>＜<code>JOIN</code> の場合＞</p><ul><li>クエリが <code>JOIN</code> だけから構成されている場合、<code>SIMPLE</code> と表示される。<br>複雑な <code>JOIN</code> であっても <code>COMPLEX</code> とはならず <code>SIMPLE</code> となるため、誤解しないよう要注意。</li><li><code>EXPLAIN</code> の出力順序がどのテーブルから処理するかを反映している。</li></ul><p>＜サブクエリの場合＞<br>サブクエリが絡む場合、以下の5種類のいずれかが出力される。<br>サブクエリの場合は実行順序に気をつける必要がある。<br><code>DERIVED</code> の場合、サブクエリ→外部クエリの順番でクエリが実行される。<br>それ以外の場合は外部クエリ→サブクエリの順番でクエリが実行される。<br>ただし <code>SUBQUERY</code> の場合はサブクエリが本当に実行されるのは最初の一回だけで、それ以降はキャッシュされた実行結果が利用される。<br><code>DEPENDENT SUBQUERY</code> および <code>UNCACHEABLE SUBQUERY</code> の場合はサブクエリが行の評価の度に実行されることになる。<br>サブクエリの場合、外部クエリとサブクエリでは別々のidがつけられる。</p><ul><li><code>PRIMARY</code>：外部クエリを示す。</li><li><code>SUBQUERY</code>：相関関係のないサブクエリ。</li><li><code>DEPENDENT SUBQUERY</code>：相関関係のあるサブクエリ。</li><li><code>UNCACHEABLE SUBQUERY</code>：実行する度に結果が変わる可能性のあるサブクエリ。</li><li><code>DERIVED</code>：<code>FROM</code> 句で用いられているサブクエリ。</li></ul><p>＜<code>UNION</code> の場合＞</p><ul><li><code>PRIMARY</code>：<code>UNION</code> において最初にフェッチされるテーブル。</li><li><code>UNION</code>：2番目以降にフェッチされるテーブル。</li><li><code>UNION RESULT</code>：<code>UNION</code> の実行結果。</li><li><code>DEPENDENT UNION</code>：<code>DEPENDENT SUBQUERY</code> が <code>UNIONに</code> なっている場合。</li><li><code>UNCACHEABLE UNION</code>：<code>UNCACHEABLE SUBQUERY</code> が <code>UNION</code> になっている場合。<br><code>&lt;derived2>UNION</code> は前から順番に処理されていくだけなので、テーブルが処理される順序という観点ではわかりやすい。</li></ul><p><strong>table</strong></p><ul><li>アクセスするテーブル。</li></ul><p><strong>type</strong></p><ul><li>テーブルへのアクセスの種類。</li><li>対象のテーブルに対してどのような方法でアクセスするかを示すもの。</li></ul><p>＜詳細＞</p><ul><li><code>const</code>：<code>PRIMARY KEY</code> または <code>UNIQUE</code> インデックスのルックアップによるアクセス。最速。</li><li><code>eq_ref</code>：<code>JOIN</code> において <code>PRIARY KEY</code> または <code>UNIQUE KEY</code> が利用される時のアクセスタイプ。<code>const</code> と似ているが <code>JOIN</code> で用いられるところが違う。</li><li><code>ref</code>：ユニーク（<code>PRIMARY</code> or <code>UNIQUE</code>）ではないインデックスを使って等価検索（<code>WHERE key = value</code>）を行った時に使われるアクセスタイプ。</li><li><code>range</code>：インデックスを用いた範囲検索。</li><li><code>index</code>：<code>INDEX FULL SCAN</code>（インデックス・フル・スキャン）。インデックス全体をスキャンする必要があるのでとても遅い。</li><li><code>ALL</code>：<code>TABLE FULL SCAN</code>（テーブル・フル・スキャン）。インデックスがまったく利用されていないことを示す。OLTP系の処理では改善必須。<br><code>&lt;derived2>index</code> または <code>ALL</code> の場合は、必ずクエリのチューニングをおこなうこと。</li></ul><p><strong>possible_keys</strong></p><ul><li>インデックスの候補となるキーの一覧。</li><li>Optimizer（MySQLの最適化装置）が挙げたテーブルのアクセスに利用可能なインデックスの候補。</li></ul><p><strong>key</strong></p><ul><li>実際に選択されたキー。</li><li>possible_keys に挙げられたインデックスの内容や統計情報を加味した上で、Optimizer（MySQLの最適化装置）によって選択されたインデックス。</li></ul><p><strong>key_len</strong></p><ul><li>選択されたキーの長さ。</li><li>インデックスの走査は、キー長が短い方が高速である。インデックスをつけるカラムを選ぶ時にはそのことを念頭に置くこと。</li></ul><p><strong>ref</strong></p><ul><li>比較するカラム。</li><li>検索条件で、keyと比較されている値やカラムの種類。</li></ul><p>＜詳細＞</p><ul><li>定数が指定されている場合は const と表示される。（<code>WHERE foo = 1</code> のような場合）</li><li>JOINが実行されている時には、結合する相手側のテーブルで検索条件として利用されているカラムが表示される。</li></ul><p><strong>rows</strong></p><ul><li>スキャンする見積もり行数。</li><li>あくまでもテーブル全体の行数やインデックスの分散具合から導き出された大まかな見積もりなので、実際にフェッチされる正確な行数ではないので要注意。</li><li>JOINやサブクエリが関係する場合は「外部表の rows x 内部表の rows」がスキャンする行になる。<br><a href=http://nippondanji.blogspot.com/2009/03/mysqlexplain.html>http://nippondanji.blogspot.com/2009/03/mysqlexplain.html</a></li></ul><p><strong>Extra</strong></p><ul><li>Optimizer（MySQLの最適化装置）がどのような戦略を選択したか。<br>「optimizer の独り言」</li></ul><p>＜詳細＞</p><ul><li><code>Using where</code>：頻繁に出力される追加情報である。<code>WHERE</code> 句に検索条件が指定されており、なおかつインデックスを見ただけではWHERE句の条件を全て適用することが出来ない場合に表示される。</li><li><code>Using index</code>：クエリがインデックスだけを用いて解決できることを示す。<code>Covering Index</code> を利用している場合などに表示される。</li><li><code>Using filesort</code>：ソートに必要な領域がメモリ上に乗り切らずに物理ファイルに書き出しソートを行う。</li><li><code>Using temporary</code>：JOINの結果をソートしたり、<code>DISTINCT</code> による重複の排除を行う場合など、クエリの実行にテンポラリテーブルが必要なことを示す。</li><li><code>Using index for group-by</code>：<code>MIN</code> <code>MAX</code> が <code>GROUP BY</code> 句と併用されているとき、クエリがインデックスだけを用いて解決できることを示す。</li><li><code>Range checked for each record (index map: N)</code>：<code>JOIN</code> において <code>range</code> または <code>index_merge</code> が利用される場合に表示される。</li><li><code>Not exists</code>：<code>LEFT JOIN</code> において、左側のテーブルからフェッチされた行にマッチする行が右側のテーブルに存在しない場合、右側のテーブルは <code>NULL</code> となるが、右側のテーブルがNOT NULLとして定義されたフィールドで <code>JOIN</code> されている場合にはマッチしない行を探せば良い：ということを示す。</li><li><code>Using filesort</code> と <code>Using temporaty</code> が表示されたら、必ずチューニングすること。</li><li><code>Using filesort</code> とは？<ul><li><a href=http://nippondanji.blogspot.com/2009/03/using-filesort.html>http://nippondanji.blogspot.com/2009/03/using-filesort.html</a></li><li>クエリにORDER BYが含まれる場合、MySQLはある程度の大きさまでは全てメモリ内でクイックソートを処理する。</li><li>ある程度の大きさとはsort_buffer_sizeであり、これはセッションごとに変更可能である。</li><li>ソートに必要なメモリがsort_buffer_sizeより大きくなると、テンポラリファイル（テンポラリテーブルではない）が作成され、メモリとファイルを併用してクイックソートが実行される。</li></ul></li></ul><h2 id=クエリの改善策>クエリの改善策
<a class=anchor href=#%e3%82%af%e3%82%a8%e3%83%aa%e3%81%ae%e6%94%b9%e5%96%84%e7%ad%96>#</a></h2><h3 id=レコード数を絞れる条件は早い段階で記述>レコード数を絞れる条件は早い段階で記述
<a class=anchor href=#%e3%83%ac%e3%82%b3%e3%83%bc%e3%83%89%e6%95%b0%e3%82%92%e7%b5%9e%e3%82%8c%e3%82%8b%e6%9d%a1%e4%bb%b6%e3%81%af%e6%97%a9%e3%81%84%e6%ae%b5%e9%9a%8e%e3%81%a7%e8%a8%98%e8%bf%b0>#</a></h3><blockquote class="book-hint danger">負債は早く返さないと、あとでツケを払うことになる。</blockquote><ul><li>WHERE句の条件で対象レコード数が少なくなる条件を先に記述。</li><li>JOINの条件は結合前の絞り込み、WHEREは結合後の絞り込みのため、JOINに抽出条件を記述したほうが効率が良い。と以前教わった。</li></ul><h3 id=サブクエリを引数にとる場合in句よりもexistsを使用>サブクエリを引数にとる場合、IN句よりもEXISTSを使用
<a class=anchor href=#%e3%82%b5%e3%83%96%e3%82%af%e3%82%a8%e3%83%aa%e3%82%92%e5%bc%95%e6%95%b0%e3%81%ab%e3%81%a8%e3%82%8b%e5%a0%b4%e5%90%88in%e5%8f%a5%e3%82%88%e3%82%8a%e3%82%82exists%e3%82%92%e4%bd%bf%e7%94%a8>#</a></h3><p>例）授業Aと授業Bを受講している生徒</p><p>改善前）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    class_a
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    student_id <span style=color:#66d9ef>IN</span>(<span style=color:#66d9ef>SELECT</span> student_id <span style=color:#66d9ef>FROM</span> class_b);
</span></span></code></pre></div><p>改善後）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    class_a a
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>EXISTS</span>(<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> class_b b <span style=color:#66d9ef>WHERE</span> a.student_id <span style=color:#f92672>=</span> b.student_id);
</span></span></code></pre></div><h4 id=existsのほうが速いと期待できる理由>EXISTSのほうが速いと期待できる理由
<a class=anchor href=#exists%e3%81%ae%e3%81%bb%e3%81%86%e3%81%8c%e9%80%9f%e3%81%84%e3%81%a8%e6%9c%9f%e5%be%85%e3%81%a7%e3%81%8d%e3%82%8b%e7%90%86%e7%94%b1>#</a></h4><ul><li>結合キー（この場合 student_id）にインデックスが張られている場合、class_b の実表は見に行かず、インデックスを参照するのみで済む。</li><li>EXISTSは1行でも条件に合致する行を見つけたら、そこで検索を打ち切るので、INのように全件検索の必要がない。NOT EXISTS の場合も同様。</li></ul><h3 id=中間テーブルを減らす>中間テーブルを減らす
<a class=anchor href=#%e4%b8%ad%e9%96%93%e3%83%86%e3%83%bc%e3%83%96%e3%83%ab%e3%82%92%e6%b8%9b%e3%82%89%e3%81%99>#</a></h3><h4 id=having句を活用>HAVING句を活用
<a class=anchor href=#having%e5%8f%a5%e3%82%92%e6%b4%bb%e7%94%a8>#</a></h4><p>改善前）無駄な中間テーブルを使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>            sale_date,
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>MAX</span>(quantity) <span style=color:#66d9ef>AS</span> max_quantity
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>            sales_histories
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>            sale_date
</span></span><span style=display:flex;background-color:#3c3d38><span>    ) <span style=color:#66d9ef>AS</span> tmp
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    max_quantity <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><p>改善後）HAVING句を活用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    sale_date,
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>MAX</span>(quantity) <span style=color:#66d9ef>AS</span> max_quantity
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    sales_histories
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>    sale_date
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>HAVING</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    max_quantity <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><h4 id=inで複数のキーを利用する場合は1箇所にまとめる>INで複数のキーを利用する場合は1箇所にまとめる
<a class=anchor href=#in%e3%81%a7%e8%a4%87%e6%95%b0%e3%81%ae%e3%82%ad%e3%83%bc%e3%82%92%e5%88%a9%e7%94%a8%e3%81%99%e3%82%8b%e5%a0%b4%e5%90%88%e3%81%af1%e7%ae%87%e6%89%80%e3%81%ab%e3%81%be%e3%81%a8%e3%82%81%e3%82%8b>#</a></h4><p>改善前）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    id,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>state</span>,
</span></span><span style=display:flex><span>    city
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    addresses1 a1
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    a1.<span style=color:#66d9ef>state</span> <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> a2.<span style=color:#66d9ef>state</span> <span style=color:#66d9ef>FROM</span> address2 a2 <span style=color:#66d9ef>WHERE</span> a1.id <span style=color:#f92672>=</span> a2.id)
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>AND</span> a1.city <span style=color:#66d9ef>IN</span>(<span style=color:#66d9ef>SELECT</span> a2.city <span style=color:#66d9ef>FROM</span> address2 a2 <span style=color:#66d9ef>WHERE</span> a1.id <span style=color:#f92672>=</span> a2.id);
</span></span></code></pre></div><p>改善後）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    addresses1 a1
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    (id, <span style=color:#66d9ef>state</span>, city) <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id, <span style=color:#66d9ef>state</span>, city <span style=color:#66d9ef>FROM</span> address2 a2);
</span></span></code></pre></div><h3 id=ソートを回避>ソートを回避
<a class=anchor href=#%e3%82%bd%e3%83%bc%e3%83%88%e3%82%92%e5%9b%9e%e9%81%bf>#</a></h3><h4 id=ソートが発生する代表的な演算>ソートが発生する代表的な演算
<a class=anchor href=#%e3%82%bd%e3%83%bc%e3%83%88%e3%81%8c%e7%99%ba%e7%94%9f%e3%81%99%e3%82%8b%e4%bb%a3%e8%a1%a8%e7%9a%84%e3%81%aa%e6%bc%94%e7%ae%97>#</a></h4><ul><li><code>GROUP BY</code></li><li><code>ORDER BY</code></li><li><code>DISTINCT</code></li><li>集約関数：<code>SUM</code>、<code>COUNT</code>、<code>AVG</code>、<code>MAX</code>、<code>MIN</code> etc</li><li>集合演算子：<code>UNION</code>、<code>INTERSECT</code>、<code>EXCEPT</code> etc</li><li>ウィンドウ関数：<code>RANK</code>、<code>ROW_NUMBER</code> etc （MySQL8以降）</li></ul><h4 id=distinctをexistsで代用>DISTINCTをEXISTSで代用
<a class=anchor href=#distinct%e3%82%92exists%e3%81%a7%e4%bb%a3%e7%94%a8>#</a></h4><p>結合に劣らず高速に動作</p><p>改善前）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>DISTINCT</span>(i.item_no)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    items i
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> sales_histories s <span style=color:#66d9ef>ON</span> i.item_no <span style=color:#f92672>=</span> s.item_no;
</span></span></code></pre></div><p>改善後）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    item_no
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    items i
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>EXISTS</span>(<span style=color:#66d9ef>SELECT</span> s.id <span style=color:#66d9ef>FROM</span> sales_histories s <span style=color:#66d9ef>WHERE</span> i.item_no <span style=color:#f92672>=</span> s.item_no);
</span></span></code></pre></div><h3 id=where句で書ける条件はhaving句には書かない>WHERE句で書ける条件はHAVING句には書かない
<a class=anchor href=#where%e5%8f%a5%e3%81%a7%e6%9b%b8%e3%81%91%e3%82%8b%e6%9d%a1%e4%bb%b6%e3%81%afhaving%e5%8f%a5%e3%81%ab%e3%81%af%e6%9b%b8%e3%81%8b%e3%81%aa%e3%81%84>#</a></h3><p>改善前）集約した後にHAVING句でフィルタリング</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    sale_date,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SUM</span>(quantity)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    sales_histories
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>    sale_date
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>HAVING</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    sale_date <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2020-01-01&#39;</span>;
</span></span></code></pre></div><p>改善後）集約する前にWHERE句でフィルタリング</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    sale_date,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SUM</span>(quantity)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    sales_histories
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    sale_date <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2020-01-01&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>    sale_date;
</span></span></code></pre></div><p>HAVING句は、集約した後のビューに対する条件を設定するが、残念なことに集約後のビューは元テーブルのインデックスまでは引き継がないケースが多い。</p><h3 id=groupby句とorderby句でインデックスを使用する>GROUPBY句とORDERBY句でインデックスを使用する
<a class=anchor href=#groupby%e5%8f%a5%e3%81%a8orderby%e5%8f%a5%e3%81%a7%e3%82%a4%e3%83%b3%e3%83%87%e3%83%83%e3%82%af%e3%82%b9%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%99%e3%82%8b>#</a></h3><ul><li>GROUP BY句やORDER BY句は、通常 並べ替えのためのソートをおこなう。</li><li>インデックスの存在する列をキーに指定すること。</li></ul><p>極値関数（MAX/MIN）でインデックスを使用する<br>例）item_no インデックスなし、item_id インデックス あり</p><p>改善前）全件検索が必要</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>MAX</span>(item_no) <span style=color:#66d9ef>FROM</span> items;
</span></span></code></pre></div><p>改善後）インデックスのスキャンだけ済ませ実表への検索を回避</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>MAX</span>(item_id) <span style=color:#66d9ef>FROM</span> items;
</span></span></code></pre></div><h2 id=インデックス>インデックス
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%83%87%e3%83%83%e3%82%af%e3%82%b9>#</a></h2><h3 id=インデックスの操作>インデックスの操作
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%83%87%e3%83%83%e3%82%af%e3%82%b9%e3%81%ae%e6%93%8d%e4%bd%9c>#</a></h3><p>インデックスの確認</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>テーブル名</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>FROM</span> sample_table;
</span></span></code></pre></div><p>インデックスの追加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#960050;background-color:#1e0010>テーブル名</span> <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#960050;background-color:#1e0010>インデックス名</span>(<span style=color:#960050;background-color:#1e0010>カラム名</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> posts <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>INDEX</span> index_posts_on_updated_at(updated_at);
</span></span></code></pre></div><p>複合インデックスの追加</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> posts <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>INDEX</span> index_posts_on_created_at_updated_at(created_at, updated_at);
</span></span></code></pre></div><p>インデックスを削除</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#960050;background-color:#1e0010>テーブル名</span> <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#960050;background-color:#1e0010>インデックス名</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> posts <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>INDEX</span> index_posts_on_updated_at;
</span></span></code></pre></div><h3 id=インデックスを追加する際のポイント>インデックスを追加する際のポイント
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%83%87%e3%83%83%e3%82%af%e3%82%b9%e3%82%92%e8%bf%bd%e5%8a%a0%e3%81%99%e3%82%8b%e9%9a%9b%e3%81%ae%e3%83%9d%e3%82%a4%e3%83%b3%e3%83%88>#</a></h3><ul><li>カーディナリティの高いカラムを選択。</li><li>複合インデックスのカラム順に注意。指定順が重要。（country_id, city_id）</li><li>更新性能・キャッシュ効率が低下するため必要なものにだけ貼ること。</li></ul><h3 id=カーディナリティとは>カーディナリティとは
<a class=anchor href=#%e3%82%ab%e3%83%bc%e3%83%87%e3%82%a3%e3%83%8a%e3%83%aa%e3%83%86%e3%82%a3%e3%81%a8%e3%81%af>#</a></h3><ul><li>インデックス内のユニークな値の多さを表した指標。<ul><li>高い例：AUTO_INCREMENT, 住所, 更新日時</li><li>低い例：フラグ, 性別, カテゴリー, 都道府県</li></ul></li><li>カーディナリティが低いと効果が少ない。絞り込めない可能性が高い。</li><li>また、インデックスを経由することによるオーバーヘッドが無視できない。</li><li>分布が偏っていれば効果が大きくなる可能性がある、条件によって効果が異なる。</li></ul><h3 id=インデックスが適用されないケース>インデックスが適用されないケース
<a class=anchor href=#%e3%82%a4%e3%83%b3%e3%83%87%e3%83%83%e3%82%af%e3%82%b9%e3%81%8c%e9%81%a9%e7%94%a8%e3%81%95%e3%82%8c%e3%81%aa%e3%81%84%e3%82%b1%e3%83%bc%e3%82%b9>#</a></h3><ul><li><code>Extra</code> 欄が <code>Using where</code> の場合 かつ インデックスが使われていない場合、対象テーブルの行を1つ1つスキャンして探していることになる。</li></ul><p><strong>NULL述語を指定している場合</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span></code></pre></div><p>IS NOT NULLの代用案</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><ul><li>原理：最小値より小さい数を指定して不等号を使えば、<code>indexed_column</code> のすべての値が選択される。</li><li>NULLの行だけ <code>indexed_column > NULL</code> が <code>unknown</code> に評価され抽出の対象外となる。</li><li>このようなトリッキーな記述は読み手を混乱させる可能性があるため、どうしても必要な場合のみ使用すること。</li></ul><p><strong>左辺で関数を使用している場合</strong></p><p>例）文字列の処理<br>改善前）左辺で関数を使用しているためインデックスが適用されないケース</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>SUBSTRING</span>(indexed_column, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;abc&#39;</span>
</span></span></code></pre></div><p>改善後）関数を使用せず別な方法で代用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;abc%&#39;</span>
</span></span></code></pre></div><p>例）暗号化/復号化<br>改善前）左辺で関数を使用しているためインデックスが適用されないケース</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> AES_DECRYPT(indexed_column, <span style=color:#e6db74>&#39;Encryption Key&#39;</span>) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;foo@bar.com&#39;</span>
</span></span></code></pre></div><p>改善後）右辺で暗号化し完全一致するためインデックスが適用されるケース</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>=</span> AES_ENCRYPT(<span style=color:#e6db74>&#39;foo@bar.com&#39;</span>, <span style=color:#e6db74>&#39;Encryption Key&#39;</span>)
</span></span></code></pre></div><p><strong>演算処理を使用している場合</strong></p><p>改善前）左辺に演算処理が含まれておりインデックスが適用されないケース</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>
</span></span></code></pre></div><p>改善策）インデックスを貼る場合「左辺は裸」が基本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p><strong>否定形での条件指定している場合</strong></p><p><code>&lt;></code>, <code>!=</code>, <code>NOT IN</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>&lt;&gt;</span> <span style=color:#e6db74>&#39;abc&#39;</span>
</span></span></code></pre></div><p><strong>ORでの条件指定している場合</strong></p><p>改善前）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;abc&#39;</span> <span style=color:#66d9ef>OR</span> indexed_column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;def&#39;</span>
</span></span></code></pre></div><p>改善後）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;abc&#39;</span>, <span style=color:#e6db74>&#39;def&#39;</span>)
</span></span></code></pre></div><p><strong>中間一致・後方一致でのLIKE述語を使用している場合</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- NG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>WHERE</span> indexed_column <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;%abc%&#39;</span>
</span></span></code></pre></div><p>Note: 前方一致の場合は インデックスが適用される</p><p><strong>複合インデックスが貼ってあるが、WHERE句の列の順番誤りの場合</strong></p><p>質問）<code>(col_1, col_2, col_3)</code> の順番で複合インデックスが貼られている場合<br>以下の①〜④の中でインデックスが適用されるものはどれ？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- ①
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>AND</span> col_2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>AND</span> col_3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ②
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>AND</span> col_2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ③
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span><span style=color:#960050;background-color:#1e0010>　</span>col_1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>AND</span> col_3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ④
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span><span style=color:#960050;background-color:#1e0010>　</span>col_2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>AND</span> col_3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>;
</span></span></code></pre></div><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>答え</span>
<span>...</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner">① OK<br>② OK<br>③ NG<br>④ NG</div></label></div><p><strong>暗黙の型変換している場合</strong></p><p>カラム <code>col_1</code> が文字列型の場合、インデックスが適用ものはどれ？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- ①
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ②
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;10&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- ③
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>CAST</span>(<span style=color:#ae81ff>10</span> <span style=color:#66d9ef>AS</span> CHAR);
</span></span></code></pre></div><div class=book-expand><label><div class="book-expand-head flex justify-between"><span>答え</span>
<span>...</span></div><input type=checkbox class=hidden><div class="book-expand-content markdown-inner">① NG<br>② OK<br>③ OK ※ CAST(10, AS CHAR(2)) によって文字列として扱われるため。</div></label></div><p>暗黙の型変換は、オーバーヘッドを発生させるだけでなく、インデックスまで使用不可になる。<br>MySQLではエラーにならないが、PostgreSQLの場合はエラーになる。</p><p><strong>小さなテーブルの場合、または、テーブルの大半の行が対象の場合、インデックスを処理する方が遅くなるケース</strong></p><blockquote><p>小さなテーブルまたは、レポートクエリーが行の大半またはすべてを処理する大きなテーブルに対するクエリーでは、インデックスはあまり重要ではありません。クエリーで行の大半にアクセスする必要がある場合は、順次読み取る方が、インデックスを処理するより高速です。クエリーですべての行が必要でない場合でも、順次読み取りは、ディスクシークを最小にします。</p></blockquote><p>引用：<a href=https://dev.mysql.com/doc/refman/5.6/ja/mysql-indexes.html>8.3.1 MySQL のインデックスの使用の仕組み</a></p><h2 id=その他>その他
<a class=anchor href=#%e3%81%9d%e3%81%ae%e4%bb%96>#</a></h2><h3 id=index-full-scan-全索引検索とは><code>INDEX FULL SCAN</code> (全索引検索)とは
<a class=anchor href=#index-full-scan-%e5%85%a8%e7%b4%a2%e5%bc%95%e6%a4%9c%e7%b4%a2%e3%81%a8%e3%81%af>#</a></h3><ul><li>複合インデックスのうち1つしか効いていない場合、ツリー構造の複合インデックスの組み合わせを すべてスキャンする状態のこと。</li></ul><p>例）</p><ul><li>複合インデックス　<code>(col_1, col_2)</code></li><li><code>WHERE</code> 句で処理する時点で <code>col_2</code> が順番誤りのためインデックスの適用外。</li><li>その後処理される <code>ORDER BY</code> 句の <code>col_1</code> のみインデックスが適用。</li><li>結果的に複合インデックスのすべてのスキャンが必要。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> col_1, col_2, col_3 <span style=color:#66d9ef>FROM</span> sample_table <span style=color:#66d9ef>WHERE</span> col_2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> col_1;
</span></span></code></pre></div><h2 id=参照>参照
<a class=anchor href=#%e5%8f%82%e7%85%a7>#</a></h2><ul><li><a href=https://dev.mysql.com/doc/refman/5.6/ja/explain.html>MySQL 公式ドキュメント</a></li><li><a href=https://books.rakuten.co.jp/rb/15596931/>達人に学ぶSQL徹底指南書 第2版</a></li><li><a href=https://books.rakuten.co.jp/rb/13190627/>SQL実践入門</a></li><li><a href=https://www.slideshare.net/techblogyahoo/mysql-58540246>MySQL勉強会 Yahoo</a></li><li><a href=https://www.slideshare.net/microad_engineer/my-sql-22426126>MySQL勉強会</a></li><li><a href=http://nippondanji.blogspot.com/2009/03/mysqlexplain.html>MySQLのEXPLAINを徹底開設</a></li><li><a href=http://nippondanji.blogspot.com/2009/03/using-filesort.html>Using filesort</a></li><li><a href=https://gihyo.jp/dev/serial/01/mysql-road-construction-news/0007>スロークエリログ</a></li><li><a href=https://github.com/major/MySQLTuner-perl>MySQL Tuner</a></li><li><a href=https://sh2.hatenablog.jp/entry/20111217>津島博士のパフォーマンス講座　 第21回 索引について（２）</a></li><li><a href=https://qiita.com/katsukii/items/3409e3c3c96580d37c2b>MySQLのIndexをはるコツ</a></li><li><a href=https://qiita.com/kichiweb/items/e7de801f972d9b41ef01>MySQLでAES_ENCRYPTとAES_DECRYPTでvarbinary型のINDEX動作</a></li><li><a href=https://qiita.com/towtow/items/4089dad004b7c25985e3>DBのインデックスと複合インデックス</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><h2>Tags</h2><ul class=tags><li><a href=/tags/mysql>MySQL</a><li><a href=/tags/sql>SQL</a><li><a href=/tags/explain>EXPLAIN</a></ul><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#前提>前提</a></li><li><a href=#sqlチューニングの手順>SQLチューニングの手順</a></li><li><a href=#スロークエリーログ>スロークエリーログ</a><ul><li><a href=#設定の項目>設定の項目</a></li><li><a href=#設定の方法>設定の方法</a></li><li><a href=#設定の確認>設定の確認</a></li></ul></li><li><a href=#集計方法>集計方法</a><ul><li><a href=#集計の種類>集計の種類</a></li><li><a href=#mysqldumpslow-コマンドの使用方法><code>mysqldumpslow</code> コマンドの使用方法</a></li><li><a href=#mysqldumpslow-コマンドのオプション><code>mysqldumpslow</code> コマンドのオプション</a></li></ul></li><li><a href=#実行計画>実行計画</a><ul><li><a href=#実行計画とは>実行計画とは</a></li><li><a href=#確認の構文>確認の構文</a></li><li><a href=#確認のステップ>確認のステップ</a></li><li><a href=#項目の説明>項目の説明</a></li></ul></li><li><a href=#クエリの改善策>クエリの改善策</a><ul><li><a href=#レコード数を絞れる条件は早い段階で記述>レコード数を絞れる条件は早い段階で記述</a></li><li><a href=#サブクエリを引数にとる場合in句よりもexistsを使用>サブクエリを引数にとる場合、IN句よりもEXISTSを使用</a></li><li><a href=#中間テーブルを減らす>中間テーブルを減らす</a></li><li><a href=#ソートを回避>ソートを回避</a></li><li><a href=#where句で書ける条件はhaving句には書かない>WHERE句で書ける条件はHAVING句には書かない</a></li><li><a href=#groupby句とorderby句でインデックスを使用する>GROUPBY句とORDERBY句でインデックスを使用する</a></li></ul></li><li><a href=#インデックス>インデックス</a><ul><li><a href=#インデックスの操作>インデックスの操作</a></li><li><a href=#インデックスを追加する際のポイント>インデックスを追加する際のポイント</a></li><li><a href=#カーディナリティとは>カーディナリティとは</a></li><li><a href=#インデックスが適用されないケース>インデックスが適用されないケース</a></li></ul></li><li><a href=#その他>その他</a><ul><li><a href=#index-full-scan-全索引検索とは><code>INDEX FULL SCAN</code> (全索引検索)とは</a></li></ul></li><li><a href=#参照>参照</a></li></ul></nav></div></aside></main></body></html>